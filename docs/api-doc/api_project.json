{
  "name": "chat-server-doc",
  "version": "1.0.0",
  "description": "JobSity Challenge Text Chat Server API Documentation",
  "title": "JobSity Challenge Text Chat Server API Documentation",
  "url": "https://chat.jobsity.ikoabo.com",
  "header": {
    "title": "Chat Server API",
    "content": "<h1>Text Based Chat Server</h1>\n<p>Chat Server is an small microservice developed to allow simple users communication using public chatrooms. User must be registered into account service and then can talk into differents chatrooms.</p>\n<p>This solutions was developed using Socket.io tecnology for real time communication and express to trigger some actions on the server. Users must join to chat rooms to be allowed send messages to it.</p>\n<p>Express actions are:</p>\n<ul>\n<li>Create chatroom</li>\n<li>Join chatroom</li>\n<li>Leave chatroom</li>\n<li>Send message</li>\n</ul>\n<p>There are also actions called using socket.io:</p>\n<ul>\n<li>Event of client disconnect: Close all resources of the client active connection</li>\n<li>Event of chatroom switch: Swith to a chatroom returning all information of the chatroom users and historic messages</li>\n<li>Real time event of writting action: Event triggered by clients and server when a client is writting on a chatroom</li>\n<li>Event of chatroom history: Request chatroom historic messages</li>\n</ul>\n<p>Each one of this actions can trigger other actions that are reflected in Socket.io events:</p>\n<ul>\n<li>Chatroom trigger: Trigger a notification on clients of new chatroom creation. Also notify the client about the server chatrooms.</li>\n<li>Join trigger: Send a notification to users that one user join to chatroom</li>\n<li>Leave trigger: Send a notification to users that one user leave to chatroom</li>\n<li>Message trigger: Send a notification to chatrooms of generated new</li>\n</ul>\n<h2>Installation of the service</h2>\n<ul>\n<li>Clone the repository</li>\n</ul>\n<pre class=\"prettyprint\">git clone https://gitlab.com/jobsity1/challenge/chat-server.git\n</code></pre>\n<ul>\n<li>Install dependencies</li>\n</ul>\n<pre class=\"prettyprint\">cd chat-server\nnpm install\nnpm install --build-from-source farmhash\n</code></pre>\n<p>Note than <code>farmhash</code> dependency must be installed from source code because prebuilt binaries aren't compatible with all architectures.</p>\n<ul>\n<li>Build the project</li>\n</ul>\n<pre class=\"prettyprint\">npm run build\n</code></pre>\n<h2>Running the service</h2>\n<p>To run the service <code>redis</code> server and <code>rabbitmq</code> server must be runing (See next section). The service can be runned directly from the command line with:</p>\n<pre class=\"prettyprint lang-bash\">npm start\n</pre>\n<p>or it can be build and runned watching for file changes</p>\n<pre class=\"prettyprint\">npm run dev\n</code></pre>\n<p>To run the service there are some environment variables that can be used to configure it:</p>\n<ul>\n<li><code>LOG</code>: Set the vebose level of the service debugger, allowed values are: error, warn, info, http, verbose, debug, silly (Default: debug)</li>\n<li><code>PORT</code>: Set the running port for the HTTP server (Default: 3000)</li>\n<li><code>INTERFACE</code>: Set the HTTP server listening interface (Default: 127.0.0.1)</li>\n<li><code>ENV</code>: Set the service running mode, allowd values are: dev, production (Default: dev)</li>\n<li><code>INSTANCES</code>: Set the number o workers runing into the cluster (Default: 1)</li>\n<li><code>MONGODB_URI</code>: Set the MongoDB database connection URI (Default: mongodb://127.0.0.1:27017/chat_srv)</li>\n<li><code>AUTH_SERVER</code>: Set the base URL to call for accounts validation (Default: https://accounts.jobsity.ikoabo.com)</li>\n<li><code>REDIS_SERVER</code>: Redis server (Default: 127.0.0.1)</li>\n<li><code>REDIS_PORT</code>: Redis server port (Default: 6379)</li>\n<li><code>REDIS_KEY</code>: Redis group key (Default: chat.adapter.io)</li>\n<li><code>AMQP_PROTOCOL</code>: Rabbitmq server protocol (Default: amqp)</li>\n<li><code>AMQP_SERVER</code>: Rabbitmq server address (Default: 127.0.0.1)</li>\n<li><code>AMQP_PORT</code>: Rabbitmq server port (Default: 5672)</li>\n<li><code>AMQP_USERNAME</code>: Rabbitmq server username to authenticate (Default: guest)</li>\n<li><code>AMQP_PASSWORD</code>: Rabbitmq server password to authenticate (Default: guest)</li>\n<li><code>AMQP_QUEUE</code>: Rabbitmq queue to receive message notifications from bots (Default: bot-jobsity-chat)</li>\n<li><code>AMQP_BOT_QUEUE_BOT</code>: Rabbitmq queue to send command requests to bots (Default: bot-jobsity-bot)</li>\n</ul>\n<h2>Deploy on server</h2>\n<h3>Install Redis server</h3>\n<p>Redis server is used by socket.io as adapter con connect sockets on running cluster schema. This solution don't use any special settings on redis. To install redis server you must run:</p>\n<pre class=\"prettyprint\">apt install redis redis-server\n</code></pre>\n<p>Automatically redis will start the server and it can be used with any other configuration. For Windows you must use the windows redis distribution.</p>\n<h3>Install RabbitMQ server</h3>\n<p>RabbitMQ is a robust server of message queuing using AMQP protocol. In this solution RabbitMQ is used to comunicate the chat server with the bots server to send command requests and receive the responses from the bots. To install the RabbitMQ server you must run:</p>\n<pre class=\"prettyprint\">apt install rabbitmq-server\nrabbitmqctl add_user challenge challenge*2020\nrabbitmqctl set_user_tags challenge administrator\nrabbitmqctl set_permissions -p / challenge \".*\" \".*\" \".*\"\n</code></pre>\n<p>For Windows you must use the windows redis distribution.</p>\n<p>Once the server is installed we must enable the administrative interface running:</p>\n<pre class=\"prettyprint\">sudo rabbitmq-plugins enable rabbitmq_management\n</code></pre>\n<p>Now the administrative interface its accesible from <code>http://&lt;ip address&gt;:15672</code></p>\n<p>To acces we must use the <code>challenge</code> credentials created and create new credentials for the bot and chat server. In this solution we use the same for both, but it can use differents. The connection to RabbitMQ is authenticated with credentials but for messages, the requests are authenticated internally with the accounts server.</p>\n<p>Messages has the following fields:</p>\n<ul>\n<li><code>chatroom</code>: Chatroom identifier that generate the message</li>\n<li><code>token</code>: Access token of the account that generate the message</li>\n<li><code>message</code>: Message generated</li>\n</ul>\n<p>For message communication the solution use two queues, that can use the default name or custom names. Both queue must be created before running the services. Both queues must be transcient, in other words, without persistence.</p>\n<ul>\n<li><code>bot-jobsity-chat</code>: Queue used to send command request from chat service to bots service</li>\n<li><code>bot-jobsity-bot</code>: Queue used to send command responses from bot service to chat service</li>\n</ul>\n<h3>Run as service</h3>\n<p>To allow the microservice to run as system service, first you must install <code>pm2</code>:</p>\n<pre class=\"prettyprint\">npm i -g pm2\n</code></pre>\n<p>After that, you must create the ecosystem file to launch the service:</p>\n<pre class=\"prettyprint\">nano ecosystem.config.js\n</code></pre>\n<p>The <code>ecosystem.config.js</code> file contains the following lines:</p>\n<pre class=\"prettyprint\">module.exports = {\n  apps : [{\n    name: 'CHAT-JOBSITY',\n    script: 'dist/index.js',\n    autorestart: true,\n    watch: false,\n    env: {\n      NODE_ENV: 'development',\n      ENV: 'dev',\n      PORT: 8002,\n      INSTANCES: 2,\n      LOG: 'debug',\n      MONGODB_URI: 'mongodb://127.0.0.1:27017/srv_chat',\n      AUTH_SERVER: 'https://accounts.jobsity,ikoabo.com',\n      REDIS_SERVER: '127.0.0.1',\n      REDIS_PORT: 6379,\n      REDIS_KEY: 'chat.adapter.io',\n      AMQP_PROTOCOL: 'amqp',\n      AMQP_SERVER: '127.0.0.1',\n      AMQP_PORT: 5672,\n      AMQP_USERNAME: 'challenge',\n      AMQP_PASSWORD: 'challenge*2020',\n      AMQP_QUEUE: 'bot-jobsity-chat',\n      AMQP_BOT_QUEUE_BOT: 'bot-jobsity-bot'\n    },\n  }],\n};\n\n</code></pre>\n<p>To start the service run the folowing lines:</p>\n<pre class=\"prettyprint\">pm2 start ecosystem.config.js\npm2 save\n</code></pre>\n<p>Now the accounts microservice is running as system service.</p>\n<h3>Configure Nginx web server</h3>\n<p>To allow access the service from external,you must configure a new virtual host in the Nginx server:</p>\n<pre class=\"prettyprint\">nano /etc/nginx/sites-availables/chat.jobsity.ikoabo.com\n</code></pre>\n<p>With the following code:</p>\n<pre class=\"prettyprint\">upstream mod-chat-jobsity {\n  server localhost:8002;\n}\n\nserver {\n  listen 80;\n  listen [::]:80;\n  server_name chat.jobsity.ikoabo.com;\n\n  location / {\n    proxy_pass http://mod-chat-jobsity/;\n    proxy_http_version 1.1;\n    proxy_cache_bypass $http_upgrade;\n    proxy_read_timeout 600s;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection 'upgrade';\n    proxy_set_header Host $host;\n    proxy_set_header X-Caller-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n  }\n}\n</code></pre>\n<p>And then enable the virtual host:</p>\n<pre class=\"prettyprint\">ln -s /etc/nginx/sites-available/chat.jobsity.ikoabo.com /etc/nginx/sites-enabled/chat.jobsity.ikoabo.com\n</code></pre>\n<p>To allow secure access to the service, use Let's Encrypt certificates. Certificates can be installed with the <code>certbot</code> tool:</p>\n<pre class=\"prettyprint\">certbot --nginx -d chat.jobsity.ikoabo.com\n</code></pre>\n<p>Now you can restart the Nginx server and test the microservice.</p>\n<h2>Documentation</h2>\n<p>The project its distributed with a <code>docs</code> folder. This folder contains the Postman Collection with examples for each request and the API Documentation generated with <code>apidoc</code>. To regenerate the documentation run the following command:</p>\n<pre class=\"prettyprint lang-bash\">npm run apidoc\n</pre>\n<h2>Run environment</h2>\n<p>To test this microservice it was deployed on test server:</p>\n<pre class=\"prettyprint\">https://chat.jobsity.ikoabo.com\n</code></pre>\n"
  },
  "template": {
    "withCompare": false,
    "withGenerator": true
  },
  "sampleUrl": false,
  "defaultVersion": "0.0.0",
  "apidoc": "0.3.0",
  "generator": {
    "name": "apidoc",
    "time": "2020-08-10T20:03:33.133Z",
    "url": "http://apidocjs.com",
    "version": "0.24.0"
  }
}
